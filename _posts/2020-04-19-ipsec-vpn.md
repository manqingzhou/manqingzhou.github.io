---
layout: post
title: Site-to-Site IPsec VPN
subtile: Concept and Configuration
---
To establish an Ipsec tunnel, we use a protocol called IKE (Internet Key Exchange). There are two phases to build an IPsec tunnel.

**IKE PHASE 1(ISAKMP tunnel)**

The IKE phase 1 is only used for `management traffic`. In this phase, peers are going to negotiate all the parameters for the tunnel such as hashing(md5 or sha), authentication (PSK or Digital Certificate), DH group (the strength of the key that used in key exchange process), encrption (AES,DES,3DES) and lifetime.

The phase 1 is not used to encrypt or protect the user's packets. To acheive this purpose, they decide to build a second tunnel. IKE phase 1 has 2 modes: `main mode` and `aggressive mode` which takes fewer packets and less secure.

**IKE PHASE 2(IPsec tunnel)**

This phase has only one mode, `quick mode`. This is where we build the actual tunnel.

I will jump into details about it. R1 will use the tunnel 2 and encrypt the packet as well encapulate the encrypted data with a new IP header (source ip: R1, destination ip: R2). The Layer 4 protocol would show as being Encapsulating Security Payload (ESP). The oppsite behavior of R2, de-encapsulate and de-encrypt the original packet and forward that plaintext to the server.

These tunnel sometimes are referred as secruity agreements between two VPN peers. Many times, their name is SA. Each SA has a unique number for tracking.

**IPsec negotiation steps**

- ISAKMP: IKE Phase 1 between two peers. The peers negotiate established security association policy. Once the peers are authenticated, a secured tunnel is created.
- Ipsec tunnel: IKE Phase 2

Okay, lets jump into some real configurations.


